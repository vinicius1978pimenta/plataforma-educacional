generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String              @id @default(uuid())
  name         String
  email        String              @unique
  password     String
  role         Role
  refreshToken String?
  materiais    Material[]
  vocabulario  Vocabulo[]
  atividades   Atividade[] // Professor pode criar atividades
  respostas    RespostaAtividade[] // Aluno pode responder atividades

  // Relação com Turmas em que o usuário é aluno
  turmas Turma[] @relation("TurmaAlunos")

  filhos        User[]  @relation("PaiFilho")
  responsavel   User?   @relation("PaiFilho", fields: [responsavelId], references: [id])
  responsavelId String?

  createdAt DateTime @default(now())

  Agenda Agenda[]
  Turma  Turma[]

  // Conteúdos criados pelo professor
  conteudosCriados Conteudo[] @relation("ProfessorConteudos")

  // Conteúdos que o aluno pode acessar
  conteudosAcessados Conteudo[] @relation("AlunoConteudos")
  
  // Avisos criados pelo professor
  avisos Aviso[] @relation("ProfessorAvisos")
}

model Material {
  id          String      @id @default(uuid())
  titulo      String
  conteudo    String
  traducao    String?
  professor   User        @relation(fields: [professorId], references: [id])
  professorId String
  createdAt   DateTime    @default(now())
  Atividade   Atividade[]
  Conteudo    Conteudo[]
}

model Vocabulo {
  id       String   @id @default(uuid())
  palavra  String
  traducao String
  aluno    User     @relation(fields: [alunoId], references: [id])
  alunoId  String
  criadoEm DateTime @default(now())
}

model Agenda {
  id        String   @id @default(uuid())
  aluno     User     @relation(fields: [alunoId], references: [id])
  alunoId   String
  data      DateTime
  titulo    String
  descricao String
}

model Turma {
  id   String @id @default(uuid())
  nome String

  // Professor responsável pela turma
  professor   User   @relation(fields: [professorId], references: [id])
  professorId String

  // Alunos da turma
  alunos User[] @relation("TurmaAlunos")

  // Atividades da turma
  atividades Atividade[]
  
  // Avisos da turma
  avisos Aviso[] @relation("AvisoTurmas")

  createdAt DateTime @default(now())
}

model Atividade {
  id        String @id @default(uuid())
  titulo    String
  descricao String
  conteudo  String // Conteúdo da atividade
  materia   String // Ex: "Matemática", "Português", "Inglês"

  // Adicionando materialId e criando o relacionamento com o modelo Material
  materialId String
  material   Material @relation(fields: [materialId], references: [id])

  // Campos adicionais opcionais
  tipo          TipoAtividade    @default(EXERCICIO)
  dificuldade   NivelDificuldade @default(MEDIO)
  pontuacao     Int?
  tempoEstimado Int?
  instrucoes    String?

  // Relacionamentos
  professor   User   @relation(fields: [professorId], references: [id])
  professorId String

  turma   Turma?  @relation(fields: [turmaId], references: [id])
  turmaId String?

  // Respostas dos alunos
  respostas RespostaAtividade[]

  // Metadados
  dataVencimento DateTime?
  ativa          Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model RespostaAtividade {
  id String @id @default(uuid())

  // Relacionamentos
  atividade   Atividade @relation(fields: [atividadeId], references: [id], onDelete: Cascade)
  atividadeId String

  aluno   User   @relation(fields: [alunoId], references: [id])
  alunoId String

  // Conteúdo da resposta
  resposta String
  anexos   String[]

  // Avaliação
  nota     Float?
  feedback String?
  status   StatusResposta @default(ENVIADA)

  // Timestamps
  dataEnvio    DateTime  @default(now())
  dataCorrecao DateTime?

  @@unique([atividadeId, alunoId])
}

model Conteudo {
  id          String @id @default(uuid())
  titulo      String
  descricao   String
  texto       String
  professor   User   @relation("ProfessorConteudos", fields: [professorId], references: [id])
  professorId String
  alunos      User[] @relation("AlunoConteudos")

  // Relacionamento com Material
  material   Material @relation(fields: [materialId], references: [id])
  materialId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Aviso {
  id          String   @id @default(uuid())
  titulo      String
  conteudo    String
  tipo        TipoAviso @default(GERAL)
  prioridade  PrioridadeAviso @default(NORMAL)
  ativo       Boolean  @default(true)
  
  // Professor que criou o aviso
  professor   User     @relation("ProfessorAvisos", fields: [professorId], references: [id])
  professorId String
  
  // Turmas que podem ver o aviso (opcional - se vazio, todos veem)
  turmas      Turma[]  @relation("AvisoTurmas")
  
  // Timestamps
  dataInicio    DateTime @default(now())
  dataExpiracao DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum Role {
  ALUNO
  PROFESSOR
  RESPONSAVEL
}

enum TipoAtividade {
  EXERCICIO
  PROVA
  TRABALHO
  PROJETO
  LEITURA
  PESQUISA
}

enum NivelDificuldade {
  FACIL
  MEDIO
  DIFICIL
}

enum StatusResposta {
  RASCUNHO
  ENVIADA
  CORRIGIDA
  DEVOLVIDA
}

enum TipoAviso {
  GERAL
  URGENTE
  EVENTO
  LEMBRETE
  COMUNICADO
}

enum PrioridadeAviso {
  BAIXA
  NORMAL
  ALTA
  CRITICA
}
